# K8s Health Monitor - Task Runner
# https://taskfile.dev

version: '3'

vars:
  CLUSTER_NAME: standalone-cluster
  IMAGE_NAME: registry.localhost:5001/k8s-health-monitor:latest
  K8S_BASE_DIR: ../k8s-base-cluster

tasks:
  up:
    desc: "ğŸš€ Bring up complete GitOps platform with health monitoring"
    deps: [cluster-up, build, deploy]
    cmds:
      - echo "âœ… Complete system is up and running!"
      - task: status

  down:
    desc: "â¹ï¸ Tear down complete system"
    cmds:
      - echo "ğŸ›‘ Stopping complete GitOps platform..."
      - cmd: kubectl delete -f manifests/deployment.yaml
        ignore_error: true
      - cmd: kubectl delete -f manifests/gitea.yaml
        ignore_error: true
      - cmd: helm uninstall gitea -n git
        ignore_error: true
      - cmd: "{{.K8S_BASE_DIR}}/k8s-tools/k3d cluster delete {{.CLUSTER_NAME}}"
        ignore_error: true
      - echo "âœ… System completely shut down"

  restart:
    desc: "ğŸ”„ Restart the complete system"
    cmds:
      - task: down
      - task: up

  cluster-up:
    desc: "â˜¸ï¸ Start k3d cluster and GitOps platform"
    cmds:
      - echo "ğŸ”§ Starting k3d cluster and GitOps platform..."
      - cd {{.K8S_BASE_DIR}} && ./standalone.sh
      - echo "ğŸ“¦ Adding Gitea helm repository..."
      - "{{.K8S_BASE_DIR}}/k8s-tools/helm repo add gitea-charts https://dl.gitea.io/charts/ || true"
      - "{{.K8S_BASE_DIR}}/k8s-tools/helm repo update"
    status:
      - '{{.K8S_BASE_DIR}}/k8s-tools/k3d cluster list | grep "{{.CLUSTER_NAME}}.*1/1.*0/0.*true"'

  cluster-down:
    desc: "â¹ï¸ Stop k3d cluster only"
    cmds:
      - echo "ğŸ›‘ Stopping k3d cluster..."
      - "{{.K8S_BASE_DIR}}/k8s-tools/k3d cluster delete {{.CLUSTER_NAME}}"

  build:
    desc: "ğŸ”¨ Build and push health monitor container"
    cmds:
      - echo "ğŸ”¨ Building health monitor container..."
      - docker build -t {{.IMAGE_NAME}} .
      - docker push {{.IMAGE_NAME}}
    sources:
      - src/**/*.py
      - Dockerfile
      - pyproject.toml

  deploy:
    desc: "ğŸš€ Deploy health monitor to cluster"
    deps: [wait-cluster, deploy-gitea]
    cmds:
      - echo "ğŸš€ Deploying health monitor..."
      - kubectl apply -f manifests/deployment.yaml
      - kubectl rollout status deployment/k8s-health-monitor -n monitoring --timeout=300s
      - echo "âœ… Health monitor deployed successfully"

  deploy-gitea:
    desc: "ğŸ“¦ Deploy Gitea with helm and ingress"
    deps: [wait-cluster]
    cmds:
      - echo "ğŸ“¦ Deploying Gitea..."
      - kubectl apply -f manifests/gitea.yaml
      - |
        if ! helm list -n git | grep -q gitea; then
          helm upgrade --install gitea gitea-charts/gitea \
            --namespace git \
            --set gitea.admin.username=admin \
            --set gitea.admin.password=admin123 \
            --set gitea.admin.email=admin@example.com \
            --set service.http.type=ClusterIP \
            --set ingress.enabled=false \
            --wait --timeout=300s
        else
          echo "  Gitea already deployed"
        fi
      - kubectl wait --for=condition=Ready certificate/gitea-tls -n git --timeout=120s
      - echo "âœ… Gitea deployed successfully"

  redeploy:
    desc: "ğŸ”„ Rebuild and redeploy health monitor"
    cmds:
      - task: build
      - kubectl rollout restart deployment/k8s-health-monitor -n monitoring
      - kubectl rollout status deployment/k8s-health-monitor -n monitoring --timeout=300s
      - echo "âœ… Health monitor redeployed"

  wait-cluster:
    desc: "â³ Wait for cluster to be ready"
    cmds:
      - echo "â³ Waiting for cluster to be ready..."
      - |
        for i in {1..60}; do
          if kubectl get nodes --no-headers 2>/dev/null | grep -q Ready; then
            echo "âœ… Cluster is ready"
            exit 0
          fi
          echo "  Waiting for cluster... ($i/60)"
          sleep 5
        done
        echo "âŒ Cluster failed to become ready"
        exit 1

  status:
    desc: "ğŸ“Š Show complete system status"
    cmds:
      - echo "ğŸ“Š K8s Health Monitor - System Status"
      - echo "====================================="
      - echo ""
      - |
        if {{.K8S_BASE_DIR}}/k8s-tools/k3d cluster list | grep -q "{{.CLUSTER_NAME}}.*1/1.*0/0.*true"; then
          echo "âœ… Cluster: {{.CLUSTER_NAME}} is running"
        else
          echo "âŒ Cluster: {{.CLUSTER_NAME}} is not running"
          exit 0
        fi
      - echo ""
      - echo "ğŸ¯ Pod Status:"
      - |
        TOTAL=$(kubectl get pods -A --no-headers | wc -l)
        RUNNING=$(kubectl get pods -A --no-headers | grep Running | wc -l)
        echo "  Running: $RUNNING/$TOTAL pods"
      - echo ""
      - echo "ğŸ”— Service Access:"
      - ./access-services.sh | grep -E "(Health Monitor|ArgoCD|Gitea|Test App):"
      - echo ""
      - echo "ğŸ’¡ Quick Commands:"
      - echo "  task logs    - View health monitor logs"
      - echo "  task shell   - Shell into health monitor pod"
      - echo "  task test    - Run API tests"

  logs:
    desc: "ğŸ“‹ View health monitor logs"
    cmds:
      - kubectl logs -f deployment/k8s-health-monitor -n monitoring

  shell:
    desc: "ğŸš Shell into health monitor pod"
    cmds:
      - kubectl exec -it deployment/k8s-health-monitor -n monitoring -- /bin/bash

  test:
    desc: "ğŸ§ª Test health monitor APIs"
    cmds:
      - echo "ğŸ§ª Testing Health Monitor APIs..."
      - |
        BASE_URL=$(./access-services.sh | grep "Health Monitor:" | sed 's/.*https:/https:/' | sed 's/\/$//')
        echo "Testing: $BASE_URL"
        
        echo "  âœ“ Health check..."
        curl -sk "$BASE_URL/health" | jq -r .status
        
        echo "  âœ“ Cluster status..."
        curl -sk "$BASE_URL/cluster" | jq -r .healthy
        
        echo "  âœ“ System resources..."
        curl -sk "$BASE_URL/processes/system" | jq -r '.cpu_percent, .memory_percent'
        
        echo "âœ… All API tests passed"

  clean:
    desc: "ğŸ§¹ Clean up docker images and build cache"
    cmds:
      - echo "ğŸ§¹ Cleaning up..."
      - cmd: docker rmi {{.IMAGE_NAME}}
        ignore_error: true
      - docker builder prune -f
      - echo "âœ… Cleanup complete"

  dev:
    desc: "ğŸ› ï¸ Start local development mode"
    cmds:
      - echo "ğŸ› ï¸ Starting development mode..."
      - echo "ğŸ’¡ Make sure you have kubectl context set to your cluster"
      - uv run src/k8s_health_monitor/main.py

  dev-setup:
    desc: "âš™ï¸ Setup development environment"
    cmds:
      - echo "âš™ï¸ Setting up development environment..."
      - uv sync
      - echo "âœ… Development environment ready"
      - echo "ğŸ’¡ Run 'task dev' to start local development"

  help:
    desc: "â“ Show available commands"
    cmds:
      - echo "ğŸ¯ K8s Health Monitor - Available Commands"
      - echo "========================================"
      - echo ""
      - echo "ğŸš€ Main Commands:"
      - echo "  task up        - Start complete system"
      - echo "  task down      - Stop complete system"  
      - echo "  task restart   - Restart complete system"
      - echo "  task status    - Show system status"
      - echo ""
      - echo "ğŸ”§ Development:"
      - echo "  task dev-setup - Setup development environment"
      - echo "  task dev       - Run locally"
      - echo "  task build     - Build container"
      - echo "  task redeploy  - Rebuild and redeploy"
      - echo ""
      - echo "ğŸ§ª Operations:"
      - echo "  task test      - Test APIs"
      - echo "  task logs      - View logs"
      - echo "  task shell     - Shell into pod"
      - echo "  task clean     - Clean up"

  default:
    desc: "Default task shows help"
    cmds:
      - task: help